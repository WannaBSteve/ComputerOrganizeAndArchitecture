# 第八章：操作系统支持  
计算机系统系统布局  
![操作系统布局](./%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80.png)  
### 一、操作系统概述  
    - 控制应用程序运行和在用户与硬件之间提供接口的程序  
  **目标**
  - 方便（使用）  
  - 有效（资源管理）    

#### 操作系统主要提供以下服务  
- 程序创建  
  > 提供各种工具和服务（编辑器、调试器……） 他们通常以实用程序出现，不是OS的一部分    
- 程序执行  
  > 调指令和数据到主存、初始化I/O设备等
- 存取I/O设备  
  > 每个IO设备都有特定的指令集和控制符号，OS来处理细节  
- 文件存取控制  
  > 不同I/O属性和存储介质上文件存储格式不同，且对于多用户系统，OS还要提供控制文件存取的**保护机制**  
- 系统存取  
  > 提供对资源和数据的保护，解决共享资源访问冲突  
- 错误检查和响应  
- 统计  
  > 统计各种资源的使用情况，监督参数等（对于多用户系统，可以将信息作为计费参考） 

#### 操作系统类型  
两种分类
- 批处理 & 交互式系统  
    > 批处理：许多用户程序打包后由计算机操作员成批提交处理  
    > 交互式：用户程序员直接用键盘显示器与计算机交互  
- 多道程序设计 & 单道程序设计  

#### 多道程序批处理系统 （现代操作系统的中心议题）  

> 多道程序举例  
> ![多道程序举例](./%E5%A4%9A%E9%81%93%E7%A8%8B%E5%BA%8F%E4%B8%BE%E4%BE%8B.png)  
> ![多任务化](./%E5%A4%9A%E4%BB%BB%E5%8A%A1%E5%8C%96%E5%92%8C%E5%A4%9A%E9%81%93%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1.png) 
>  
> 多道批处理利用率举例（任务1、2、3）
> ![多道批处理利用率举例](./%E5%88%A9%E7%94%A8%E7%8E%87%E7%9B%B4%E6%96%B9%E5%9B%BE.png)  

和简单的批处理系统一样，多道批处理系统也必须依赖于计算机的**硬件特性**
- 最显著的附加特点是硬件支持I/O和DMA

#### 分时系统  
正如多道程序设计允许cpu一次处理多个批量作业一样，多道程序也能同时处理多个交互式作业，即**分时技术**，*允许多个用户共享处理时间*  
若一次有n个用户请求服务，则每个用户平均只看到计算机有效速度的$1\over n$,不计操作系统开销  
**批处理多道程序和分时系统的比较**  
|  |批处理多道程序设计|分时系统|
|-|-|-|  
|**主要目标**|处理器利用率最大|响应时间最小|
|**对操作系统的源指令**|作业提供的作业控制语言命令|在终端上输入的命令|  

### 二、调度——（多道程序的关键）
|调度类型| |  
|-|-|  
|**长期调度**|决定添加到 *进程池* 中的进程数|
|**中期调度**|决定添加到 *主存* 的进程数|  
|**短期调度**|决定cpu执行哪个进程|  
|**I/O调度**|决定哪个进程未决的I/O请求将要被I/O设备处理|  

#### 长期调度  
> 决定哪些程序提交给系统处理，所以**控制多道程序的深度**，但只是粗颗粒地判断是否执行新进程、调度哪一个进程进入**系统**    
#### 中期调度  
#### 短期调度
> 短期调度程序也称**派遣程序**，频繁执行，*细粒度* 判定接下来运行哪一个**作业**  

#### 1、进程状态
- 新建：高级调度程序提交一个未就绪程序，操作系统为此程序创建一个**进程**，将它移入就绪状态  
- 就绪：等待cpu执行  
- 运行：正在被cpu执行  
- 等待：进程为等待一些**系统资源**（如I/O），由运行状态**挂起**  
- 终止：进程结束由OS**撤销**  

Tip:每个进程在OS种用一个**进程控制块**（PCB）表示  
    调度程序接收一个**新作业或用户的执行请求**时，它创建一个空的**进程控制块**，并使相关进程处于新的状态  
当系统填完PCB后，该进程进入就绪状态  

PCB包括
> - 标识符  
> - 状态  
> - 优先级  
> - 程序计数器（吓一跳指令地址）  
> - 现场数据  
> - I/O状态信息（未完成的请求、分配给进程的I/O设备和文件列表等）  
> - 统计信息（使用cpu的时间和时钟时间）  

#### 2、调度技术    
为了实现**进程调度机制**，OS需要维护多个队列（每个都是等待某些资源的进程列表）  
**长期队列**：等待 *系统资源* 的作业列表  
**短期队列**：包含所有就绪状态进程  
**I/O队列**：等待使用该设备的所有进程在其中
短期调度程序从短期队列种挑选一个进程，采用轮转算法，给每个进程轮流分配一些时间，或者优先级算法。

Tip:正在执行的进程可能被挂起  
- 若原因是**进程请求I/O服务**，则它会进入相应I/O队列  
- 若原因是**超时**或**操作系统必须处理紧急事务**，则它被设置为就绪状态，进入短期队列  
  
> **多道程序设计的OS要素**  
![多道程序设计os要素](./%E5%A4%9A%E9%81%93%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%A6%81%E7%B4%A0.png)  

> **多道程序处理的队列图**  
![多道程序处理的队列图](./%E5%A4%9A%E9%81%93%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%9A%84%E9%98%9F%E5%88%97%E5%9B%BE.png)  

### 三、存储器管理  
#### 解决处理器大多数时间处于空闲状态的方法  
- 交换  
    > 假设存储器没有进程是就绪态（所有都在等待I/O操作）  
    > 此时cpu不再保持空闲等待，而是把这些进程中的一个塞入**中间序列**并且从**中间队列**取出一个，或者处理长期队列的一个新进程请求，如b    
    > ![交换](./%E4%BA%A4%E6%8D%A2%E6%8A%80%E6%9C%AF.png)  
- 虚拟存储器  （比交换更能提高性能）  

#### 分区  
#### 分页
![逻辑地址&物理地址](./%E9%A1%B5%E8%A1%A8%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80%E5%92%8C%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80.png)  
主存划分成许多大小相等的 **帧**，每个进程划分成与帧大小一致的许多 **页**。当一个进程调入时，它的 *页* 被装入空闲 *帧* 中，且
操作系统为每个进程保存一个页表，记录了每页的**帧地址**  

#### 虚拟存储器  
1、请求分页
 - 在任何时候，进程中只有一小部分页在主存中，因而可以**使用更多的进程同时占用主存管理机制**  
 - os的存储管理机制：调入一页时必须把另一页换出————**页替换**  
  > 如果换出的刚好是要使用的，则又要把它调进来——*抖动*  
  > 页替换算法，常用如LRU等

请求分页技术的实现可以得到一个惊人的结论——**一个进程可以比主存所有的空间都大！**  
tip：  进程在主存中执行，所以主存==**实存储器**，磁盘==**虚拟存储器**  

#### 2、页表结构
大多数系统中，每个进程对应一个页表，但占据大量**虚拟存储器**
> VAX结构中，一个进程能有$2^{31}=2GB$个虚拟存储，使用$2^9$个页，即每个进程需要$2^22$个页表项
表明对页也要进行分页
> 一个进程运行时，**至少有一部分页表**必须在主存中  
- eg.二级方案组织大的页表（有一个**页目录**，每项指向一个页表）  

#### 快表  
- 每次虚拟存储其访问引起两次物理存储器的存取（搞到页表项来得到哪一帧，再通过物理地址访问内存），因此$存取时间$加倍！！！
所以引入 $TLB（快表）$，是一个高速缓存，存储最近使用过的页表项  
  
- 分页操作和快表
![分页操作和快表](./%E5%88%86%E9%A1%B5%E6%93%8D%E4%BD%9C%E5%92%8C%E5%BF%AB%E8%A1%A8.png)  

#### 分段  
分页为了提供较大空间，对程序员透明；  
分段是可见的。  
优点
  - 简化对数据结构的处理（分配大小交给os动态操作）  
  - 允许每段程序 **独立修改** 和 **重编译**，不需要频繁链接或装入  
  - 实现 **进程共享**，段间可互相访问  
  - 实现 **段保护**，程序猿赋予段 ***存取特权***  


